package com.sustentabilidade.dao;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

import com.sustentabilidade.dao.util.Conexao;
import com.sustentabilidade.modelo.Inscricao;



public class InscricaoDAO {
	private Connection connection;

	private void conectar() throws SQLException {
			if (connection == null || connection.isClosed()) {
				connection = Conexao.getConexao();
			}
		}


	private void desconectar() throws SQLException {
			if (connection != null && !connection.isClosed()) {
				connection.close();
			}
		}

	public Inscricao inserirInscricao(Inscricao inscricao) throws SQLException {
		String sql = "INSERT INTO inscricao (nome, email, data_inscricao, cidade, evento)"
					+ " VALUES (?, ?, ?, ?, ?)";

		conectar();
			
		PreparedStatement statement = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);

		statement.setString(1, inscricao.getNome());
			statement.setString(2, inscricao.getEmail());
			Date data = new Date(inscricao.getDataInscricao().getTime());
			statement.setDate(3, data);
			statement.setString(4, inscricao.getCidade());
			statement.setString(5, inscricao.getEvento());

		statement.executeUpdate();

	ResultSet resultSet = statement.getGeneratedKeys();
			long id = 0;
			if(resultSet.next())
				id = resultSet.getInt("id");

	statement.close();

			desconectar();
			
			inscricao.setId(id);
			return inscricao;
	}
public List<Inscricao> listarTodosInscricoes() throws SQLException {
		
		List<Inscricao> listaInscricoes = new ArrayList<Inscricao>();

		String sql = "SELECT * FROM inscricao";

		conectar();

		Statement statement = connection.createStatement();
		ResultSet resultSet = statement.executeQuery(sql);

		while (resultSet.next()) {
			long id = resultSet.getLong("id");
			String nome = resultSet.getString("nome");
			String email = resultSet.getString("email");
			Date data = new Date(resultSet.getDate("dataInscricao").getTime());
			String cidade = resultSet.getString("cidade");
			String evento = resultSet.getString("evento");


			Inscricao inscricao = new Inscricao(nome, email, cidade, evento, data);
			inscricao.setId(id);
			listaInscricoes.add(inscricao);
		}
		resultSet.close();
		statement.close();

		desconectar();

		return listaInscricoes;
	}
	
	public boolean apagarInscricao(Inscricao inscricao) throws SQLException {
        String sql = "DELETE FROM inscricao where id = ?";
        
        conectar();
         
        PreparedStatement statement = connection.prepareStatement(sql);
        statement.setLong(1, inscricao.getId());
         
        boolean linhaApagada = statement.executeUpdate() > 0;
        statement.close();
        
        desconectar();
        
        return linhaApagada;     
   }

}
